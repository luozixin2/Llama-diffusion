# 高并发吞吐量测试总结

## 测试概述

本次测试评估了在高并发条件下（4个并发任务），CPU和GPU采样器在不同块大小和步数配置下的极限生成速度。

**测试时间**: 2025-11-29 13:34:52  
**测试配置**: 
- 并发任务数: 4
- 测试轮数: 3轮/配置
- 生成长度: 128 tokens
- 模型: SDAR-1.7B-Chat-F16.gguf

## 测试配置

共测试了8种配置：
- **CPU采样器**: block=steps=1, 2, 4, 8 (4种)
- **GPU采样器**: block=steps=1, 2, 4, 8 (4种)

## 测试结果摘要

| 配置 | 总体吞吐量 (tokens/sec) | 平均任务吞吐量 (tokens/sec) | 平均墙钟时间 (ms) |
|------|------------------------|---------------------------|------------------|
| **CPU (block=1, steps=1)** | 99.53 | 87.12 | 5988.30 |
| **GPU (block=1, steps=1)** | 107.86 | 73.39 | 5525.53 |
| **CPU (block=2, steps=2)** | 101.50 | 88.88 | 5871.97 |
| **GPU (block=2, steps=2)** | **123.28** | **107.94** | **4834.36** |
| **CPU (block=4, steps=4)** | 79.56 | 70.04 | 7491.12 |
| **GPU (block=4, steps=4)** | 114.97 | 100.70 | 5183.91 |
| **CPU (block=8, steps=8)** | 54.79 | 47.94 | 10878.34 |
| **GPU (block=8, steps=8)** | 92.27 | 76.81 | 6459.46 |

## 关键发现

### 1. 最快配置
**GPU (block=2, steps=2)** 达到最高总体吞吐量：**123.28 tokens/sec**

### 2. CPU vs GPU 对比
- **GPU采样器在所有配置下都优于CPU采样器**
- GPU优势最明显在 block=2, steps=2 配置下，比CPU快 **21.5%**
- GPU在 block=8, steps=8 配置下优势最大，比CPU快 **68.3%**

### 3. 块大小和步数的影响
- **小块配置 (block=1,2)**: 
  - CPU和GPU性能接近
  - GPU (block=2) 表现最佳
- **中块配置 (block=4)**:
  - GPU明显优于CPU（44.4%提升）
  - 总体吞吐量仍然较高
- **大块配置 (block=8)**:
  - 性能下降明显
  - GPU优势最大（68.3%提升）
  - CPU性能下降最严重

### 4. 并发性能
- 所有配置在4并发任务下都能稳定运行
- 总体吞吐量（aggregate throughput）反映了真实的高并发场景性能
- 平均任务吞吐量（avg task throughput）反映了单个任务的性能

## 性能分析

### 吞吐量排名（总体）
1. **GPU (block=2, steps=2)**: 123.28 tokens/sec ⭐
2. **GPU (block=1, steps=1)**: 107.86 tokens/sec
3. **CPU (block=2, steps=2)**: 101.50 tokens/sec
4. **CPU (block=1, steps=1)**: 99.53 tokens/sec
5. **GPU (block=4, steps=4)**: 114.97 tokens/sec
6. **CPU (block=4, steps=4)**: 79.56 tokens/sec
7. **GPU (block=8, steps=8)**: 92.27 tokens/sec
8. **CPU (block=8, steps=8)**: 54.79 tokens/sec

### 延迟分析（墙钟时间）
- **最快**: GPU (block=2, steps=2) - 4834.36 ms
- **最慢**: CPU (block=8, steps=8) - 10878.34 ms
- GPU在延迟方面也有明显优势

## 结论

1. **推荐配置**: **GPU (block=2, steps=2)** 在4并发场景下提供最佳性能
2. **GPU优势**: GPU采样器在所有配置下都显著优于CPU采样器
3. **块大小选择**: block=2 在高并发场景下表现最佳，平衡了吞吐量和延迟
4. **并发能力**: 系统能够稳定处理4个并发生成任务

## 测试数据归档

- **结果文件**: `concurrent_throughput_results.json`
- **归档目录**: `concurrent_throughput_runs/20251129_133452/`
- **详细数据**: 包含每轮测试的详细结果和每个任务的性能数据

## 建议

1. **生产环境**: 使用 **GPU (block=2, steps=2)** 配置以获得最佳吞吐量
2. **资源受限**: 如果GPU资源有限，**CPU (block=2, steps=2)** 是次优选择
3. **进一步优化**: 可以测试更高的并发数（如8、16）以找到系统极限
4. **质量权衡**: 注意block=1,2配置可能影响生成质量，需要根据实际需求平衡

